<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Fingerprint Analysis | Enterprise Security Dashboard</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Modern fonts for enterprise look - Segoe UI fallback to system fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Enterprise Design System Styles (Primary - takes precedence) -->
    <link rel="stylesheet" href="fingerprint-ui/styles/enterprise-design-system.css">
    <link rel="stylesheet" href="fingerprint-ui/styles/enterprise-components.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
</head>
<body class="fp-page">
    <!-- Back Navigation -->
    <button class="fp-back-btn" onclick="window.history.back()" aria-label="Go back">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        <span>Back to Lab</span>
    </button>

    <!-- Main Container -->
    <div class="fp-container" id="fp-app">
        <!-- Loading state will be inserted here, then replaced with content -->
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // Import dependencies with error handling
        let BrowserFingerprintAnalyzer, StandaloneBehavioralTracker;
        let FingerprintUIRenderer, getTelemetryDescription;
        let createBehavioralLoadingState, createLoadingState, updateLoadingProgress, updateBehavioralStats, updateLoadingContent, createErrorState;
        let FingerprintConsole;
        
        try {
            const fpModule = await import('./browserFingerprint.js');
            BrowserFingerprintAnalyzer = fpModule.BrowserFingerprintAnalyzer;
        } catch (e) {
            console.error('Failed to load browserFingerprint.js:', e);
        }
        
        try {
            const btModule = await import('./behavioralTracker.js');
            StandaloneBehavioralTracker = btModule.StandaloneBehavioralTracker;
        } catch (e) {
            console.error('Failed to load behavioralTracker.js:', e);
        }
        
        try {
            const uiModule = await import('./fingerprint-ui/FingerprintRenderer.js');
            FingerprintUIRenderer = uiModule.FingerprintUIRenderer;
            getTelemetryDescription = uiModule.getTelemetryDescription || (() => 'Behavioral metric');
        } catch (e) {
            console.error('Failed to load FingerprintRenderer.js:', e);
        }
        
        try {
            const loadingModule = await import('./fingerprint-ui/components/Loading.js');
            createBehavioralLoadingState = loadingModule.createBehavioralLoadingState;
            createLoadingState = loadingModule.createLoadingState;
            updateLoadingProgress = loadingModule.updateLoadingProgress;
            updateBehavioralStats = loadingModule.updateBehavioralStats;
            updateLoadingContent = loadingModule.updateLoadingContent;
            createErrorState = loadingModule.createErrorState;
        } catch (e) {
            console.error('Failed to load Loading.js:', e);
        }
        
        try {
            const consoleModule = await import('./fingerprint-ui/components/Console.js');
            FingerprintConsole = consoleModule.FingerprintConsole;
        } catch (e) {
            console.error('Failed to load Console.js:', e);
        }
        
        // Fallback for createErrorState if not loaded
        if (!createErrorState) {
            createErrorState = (error) => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 40px; text-align: center; background: #fff3f3; border-radius: 12px; margin: 20px;';
                div.innerHTML = `
                    <h2 style="color: #d32f2f; margin-bottom: 16px;">‚ö†Ô∏è Analysis Error</h2>
                    <p style="color: #666; margin-bottom: 20px;">${error.message || 'An error occurred during fingerprint analysis'}</p>
                    <button onclick="location.reload()" style="padding: 10px 24px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Try Again
                    </button>
                `;
                return div;
            };
        }
        
        // ============================================================
        // GLOBAL STATE
        // ============================================================
        let fingerprintData = null;
        let uiRenderer = null;
        
        // ============================================================
        // HELPER: Safe function wrapper
        // ============================================================
        function safeCall(fn, fallback = null) {
            try {
                return fn();
            } catch (e) {
                console.warn('Safe call failed:', e.message);
                return fallback;
            }
        }
        
        // ============================================================
        // INITIALIZATION
        // ============================================================
        async function initializeAnalysis() {
            const appContainer = document.getElementById('fp-app');
            
            // Show initial loading state
            appContainer.innerHTML = '<div style="padding: 40px; text-align: center;"><h2>üîç Initializing Analysis...</h2></div>';
            
            try {
                // ----------------------------------------
                // Phase 1: Behavioral Data Collection
                // ----------------------------------------
                let behavioralData = {
                    indicators: {},
                    summary: { riskLevel: 'UNKNOWN', detectedCount: 0 },
                    telemetry: {},
                    metadata: {}
                };
                
                if (StandaloneBehavioralTracker && createBehavioralLoadingState) {
                    try {
                        const behavioralLoading = createBehavioralLoadingState();
                        appContainer.innerHTML = '';
                        appContainer.appendChild(behavioralLoading);
                        
                        // Create standalone behavioral tracker
                        const behavioralTracker = new StandaloneBehavioralTracker({ 
                            duration: 1000 // 1 second
                        });
                        
                        // Update UI with countdown and progress
                        const startTime = Date.now();
                        const totalDuration = 1000;
                        
                        const countdownInterval = setInterval(() => {
                            const elapsed = Date.now() - startTime;
                            const remaining = Math.max(0, Math.ceil((totalDuration - elapsed) / 1000));
                            const percentage = Math.min((elapsed / totalDuration) * 100, 100);
                            
                            if (updateLoadingProgress) {
                                updateLoadingProgress(percentage, `Time remaining: ${remaining}s - Keep interacting!`);
                            }
                            
                            // Update real-time stats
                            if (updateBehavioralStats) {
                                try {
                                    const stats = behavioralTracker.getStats();
                                    updateBehavioralStats(stats);
                                } catch (e) {
                                    // Stats may not be available yet
                                }
                            }
                            
                            if (remaining === 0) {
                                clearInterval(countdownInterval);
                            }
                        }, 100);
                        
                        // Collect behavioral data
                        console.log('üéØ Starting behavioral data collection...');
                        behavioralData = await behavioralTracker.collectBehavioralData();
                        clearInterval(countdownInterval);
                        console.log('‚úÖ Behavioral data collected:', behavioralData);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Behavioral collection failed, continuing with fingerprint:', e.message);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Behavioral tracker not available, skipping behavioral collection');
                }
                
                // ----------------------------------------
                // Phase 2: Fingerprint Analysis with Real-Time Progress
                // ----------------------------------------
                
                // Create container for loading state and console
                appContainer.innerHTML = '';
                
                // Create loading state
                if (createLoadingState) {
                    const analysisLoading = createLoadingState({
                        title: 'Analyzing Browser Fingerprint...',
                        subtitle: `Processing ${Object.keys(behavioralData.indicators || {}).length} behavioral indicators...`,
                        showProgress: true
                    });
                    appContainer.appendChild(analysisLoading);
                } else {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = 'padding: 40px; text-align: center;';
                    loadingDiv.innerHTML = '<h2>üîç Analyzing Browser Fingerprint...</h2>';
                    appContainer.appendChild(loadingDiv);
                }
                
                // Create console for detailed logging
                let fpConsole = null;
                if (FingerprintConsole) {
                    fpConsole = new FingerprintConsole({
                        container: appContainer,
                        title: 'Analysis Log',
                        expanded: true,
                        timestamps: true
                    });
                    fpConsole.info('Fingerprint analysis initialized');
                    fpConsole.info(`Behavioral indicators collected: ${Object.keys(behavioralData.indicators || {}).length}`);
                }
                
                // Run fingerprint analysis
                if (!BrowserFingerprintAnalyzer) {
                    throw new Error('BrowserFingerprintAnalyzer module failed to load');
                }
                
                // Progress callback for real-time UI updates AND console logging
                const handleProgress = (progress) => {
                    // Update loading UI
                    if (updateLoadingProgress) {
                        updateLoadingProgress(progress.percentage, progress.message);
                    }
                    
                    // Update subtitle with completed phases info
                    if (updateLoadingContent && progress.completedPhases) {
                        const phaseNames = {
                            core: 'üìä Core Properties',
                            network: 'üì° Network',
                            battery: 'üîã Battery/Storage',
                            audio: 'üîä Audio',
                            speech: 'üó£Ô∏è Speech',
                            language: 'üåê Language',
                            css: 'üé® CSS Styles',
                            webrtc: 'üì° WebRTC',
                            workers: 'üîÑ Workers',
                            fonts: 'üî§ Fonts',
                            webgl: 'üé® WebGL',
                            media: 'üé§ Media Devices',
                            activeMeasurements: '‚ö° Network Speed',
                            aiAgent: 'ü§ñ AI Detection',
                            stringSignature: 'üîç Automation Signatures',
                            knownAgents: 'üïµÔ∏è Known Agents',
                            behavioral: 'üéØ Behavioral',
                            suspicious: 'üö® Risk Analysis'
                        };
                        const completedNames = progress.completedPhases
                            .map(p => phaseNames[p] || p)
                            .slice(-3) // Show last 3 completed
                            .join(' ‚Üí ');
                        const subtitle = completedNames ? `‚úÖ ${completedNames}` : progress.message;
                        updateLoadingContent('Analyzing Browser Fingerprint...', subtitle);
                    }
                    
                    // Log to console
                    if (fpConsole) {
                        fpConsole.handleProgress(progress);
                    }
                };
                
                // Handler for known agents live updates
                const handleKnownAgentsUpdate = (updateData) => {
                    console.log('üïµÔ∏è Known agents update:', updateData);
                    
                    // Update the fingerprint data
                    if (fingerprintData) {
                        fingerprintData.knownAgentsDetection = {
                            results: updateData.results,
                            history: updateData.history,
                            isPeriodicRunning: true,
                            intervalMs: 60000
                        };
                    }
                    
                    // Alert on new agents detected
                    if (updateData.newAgentsDetected?.length > 0) {
                        console.warn(`‚ö†Ô∏è NEW AGENT(S) DETECTED: ${updateData.newAgentsDetected.join(', ')}`);
                        // You could add a visual notification here
                    }
                    
                    // Update the UI section
                    try {
                        // Dynamic import to avoid circular dependencies
                        import('./fingerprint-ui/components/AlertSection.js').then(({ updateKnownAgentsSection }) => {
                            updateKnownAgentsSection(fingerprintData.knownAgentsDetection);
                        }).catch(e => {
                            console.warn('Could not update known agents section:', e);
                        });
                    } catch (e) {
                        console.warn('Known agents UI update failed:', e);
                    }
                };
                
                const analyzer = new BrowserFingerprintAnalyzer({
                    enableActiveMeasurements: true,
                    activeMeasurements: {
                        downloadUrl: './network-test-3mb.bin',
                        expectedDownloadBytes: 3 * 1024 * 1024,
                        pingCount: 3
                    },
                    networkTimeout: 5000, // 5 second timeout for network tests
                    detectorTimeout: 3000, // 3 second timeout for individual detectors
                    onProgress: handleProgress,
                    // Known agents detection options
                    enablePeriodicAgentDetection: true,
                    agentDetectionInterval: 60000, // 1 minute
                    onKnownAgentsUpdate: handleKnownAgentsUpdate
                });
                
                // Store analyzer reference globally for cleanup
                window._fingerprintAnalyzer = analyzer;
                
                await analyzer.analyzeFingerprint();
                fingerprintData = analyzer.getAnalysisResults();
                
                // Mark console as complete
                if (fpConsole) {
                    fpConsole.complete();
                }
                
                // ----------------------------------------
                // Phase 3: Inject Behavioral Data
                // ----------------------------------------
                fingerprintData.metrics = fingerprintData.metrics || {};
                fingerprintData.metrics.behavioralIndicators = behavioralData.indicators || {};
                fingerprintData.behavioralSummary = behavioralData.summary || {};
                fingerprintData.behavioralMetadata = behavioralData.metadata || {};
                
                // Add raw behavioral telemetry as separate metrics category
                fingerprintData.metrics.behavioralTelemetry = {};
                const telemetryDescFn = getTelemetryDescription || (() => 'Behavioral metric');
                for (const [key, value] of Object.entries(behavioralData.telemetry || {})) {
                    fingerprintData.metrics.behavioralTelemetry[key] = {
                        value: value,
                        description: telemetryDescFn(key),
                        risk: 'N/A'
                    };
                }
                
                console.log('‚úÖ Complete fingerprint data:', fingerprintData);
                
                // ----------------------------------------
                // Phase 4: Render UI
                // ----------------------------------------
                if (updateLoadingProgress) {
                    updateLoadingProgress(100, 'Rendering results...');
                }
                
                // Small delay for visual feedback
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Clear container and render
                appContainer.innerHTML = '';
                
                if (FingerprintUIRenderer) {
                    uiRenderer = new FingerprintUIRenderer(appContainer, {
                        diffModeDefault: false, // Start with full view, user can toggle
                        baselinePath: './fp_base/browser-fingerprint-chrome-trivial.json'
                    });
                    await uiRenderer.render(fingerprintData);
                } else {
                    // Fallback: render basic JSON view
                    console.warn('‚ö†Ô∏è FingerprintUIRenderer not available, showing fallback view');
                    renderFallbackView(appContainer, fingerprintData);
                }
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error during fingerprint analysis:', error);
                appContainer.innerHTML = '';
                appContainer.appendChild(createErrorState(error));
            }
        }
        
        // ============================================================
        // FALLBACK RENDERER
        // ============================================================
        function renderFallbackView(container, data) {
            const metricsCount = Object.values(data.metrics || {}).reduce((sum, cat) => sum + Object.keys(cat || {}).length, 0);
            
            container.innerHTML = `
                <div style="padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <h1 style="color: #333; margin-bottom: 20px;">‚úÖ Fingerprint Analysis Complete</h1>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;">${metricsCount}</div>
                            <div style="color: #666; font-size: 12px; text-transform: uppercase;">Total Metrics</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;">${Object.keys(data.metrics || {}).length}</div>
                            <div style="color: #666; font-size: 12px; text-transform: uppercase;">Categories</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;">${(data.suspiciousIndicators || []).length}</div>
                            <div style="color: #666; font-size: 12px; text-transform: uppercase;">Suspicious Indicators</div>
                        </div>
                    </div>
                    <details style="margin-bottom: 20px;">
                        <summary style="cursor: pointer; font-weight: bold; padding: 10px; background: #f0f0f0; border-radius: 6px;">View Raw JSON Data</summary>
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow: auto; max-height: 400px; margin-top: 10px; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>
                    </details>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyData()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üìã Copy JSON</button>
                        <button onclick="downloadData()" style="padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Download JSON</button>
                    </div>
                </div>
            `;
            
            // Add copy/download functions to window
            window.copyData = () => {
                navigator.clipboard.writeText(JSON.stringify(data, null, 2))
                    .then(() => alert('‚úÖ Copied to clipboard!'))
                    .catch(err => alert('Failed to copy: ' + err));
            };
            
            window.downloadData = () => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fingerprint-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
        }
        
        // ============================================================
        // GLOBAL EXPORT FUNCTION (for legacy compatibility)
        // ============================================================
        window.exportFingerprintData = function(format) {
            if (!fingerprintData) {
                alert('No fingerprint data available for export');
                return;
            }
            
            import('./fingerprint-ui/components/Export.js').then(({ exportFingerprintData }) => {
                exportFingerprintData(fingerprintData, format);
            }).catch(err => {
                console.warn('Export module not available, using fallback');
                window.downloadData && window.downloadData();
            });
        };
        
        // ============================================================
        // START APPLICATION
        // ============================================================
        // Note: Since we use top-level await for imports, DOMContentLoaded may have 
        // already fired by the time the module finishes loading. Check and run immediately.
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAnalysis);
        } else {
            // DOM is already ready, run immediately
            initializeAnalysis();
        }
    </script>
</body>
</html>