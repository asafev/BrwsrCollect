<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay Detector - AI Agent Detection Framework</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .overlay-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--secondary-color);
        }
        
        .overlay-card.high-risk {
            border-left-color: var(--accent-color);
            background: #fdf2f2;
        }
        
        .overlay-card.medium-risk {
            border-left-color: var(--warning-color);
            background: #fff8e1;
        }
        
        .overlay-preview {
            width: 100%;
            height: 200px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .overlay-element {
            position: absolute;
            border: 2px solid var(--accent-color);
            background: rgba(231, 76, 60, 0.2);
            pointer-events: none;
            font-size: 0.8rem;
            color: var(--accent-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .z-index-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .z-meter-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .z-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--warning-color), var(--accent-color));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .z-meter-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .coverage-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            height: 100px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
        }
        
        .coverage-cell {
            background: #f0f0f0;
            border-radius: 2px;
            transition: background-color 0.3s ease;
        }
        
        .coverage-cell.covered {
            background: var(--accent-color);
        }
        
        .detection-radar {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .radar-blip {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff00;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .radar-blip.threat {
            background: #ff6b6b;
            animation: pulse-fast 1s infinite;
        }
        
        @keyframes pulse-fast {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .overlay-heatmap {
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            position: relative;
            margin: 15px 0;
        }
        
        .heatmap-point {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-color);
            opacity: 0.7;
            transform: translate(-50%, -50%);
            animation: fadeIn 0.5s ease;
        }
        
        .perplexity-detector {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .comet-test-area {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            min-height: 150px;
            position: relative;
        }
        
        .test-overlay {
            position: absolute;
            background: rgba(255, 0, 0, 0.3);
            border: 2px dashed var(--accent-color);
            pointer-events: none;
            font-size: 0.9rem;
            color: var(--accent-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideIn 0.5s ease;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">üîÜ Overlay Detector</div>
            <div>
                <span class="status" id="detector-status">Scanning</span>
            </div>
        </div>
    </header>

    <nav>
        <div class="nav-container">
            <ul class="nav-menu">
                <li class="nav-item"><a href="../index.html" class="nav-link">Dashboard</a></li>
                <li class="nav-item"><a href="dom-monitor.html" class="nav-link">DOM Monitor</a></li>
                <li class="nav-item"><a href="extension-detector.html" class="nav-link">Extensions</a></li>
                <li class="nav-item"><a href="stylesheet-monitor.html" class="nav-link">Stylesheets</a></li>
                <li class="nav-item"><a href="overlay-detector.html" class="nav-link active">Overlays</a></li>
                <li class="nav-item"><a href="live-dashboard.html" class="nav-link">Live Dashboard</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üîÜ Overlay & High Z-Index Detection</h2>
                <p class="card-subtitle">Detect overlays, modals, and high z-index elements that may indicate AI agent control</p>
            </div>
            
            <div class="scan-controls">
                <button id="start-detection" class="btn btn-success">Start Detection</button>
                <button id="stop-detection" class="btn btn-danger">Stop Detection</button>
                <button id="scan-current" class="btn btn-primary">Scan Current Overlays</button>
                <button id="highlight-overlays" class="btn btn-warning">Highlight Overlays</button>
                <button id="export-overlay-data" class="btn btn-secondary">Export Data</button>
                <label>
                    <input type="checkbox" id="continuous-scan" checked> Continuous scanning
                </label>
            </div>
        </div>

        <div class="perplexity-detector">
            <h3>ü§ñ Perplexity Comet Agent Detection</h3>
            <p>Specialized detection for Perplexity Comet agent overlays and control elements</p>
            <div class="scan-controls">
                <button id="test-comet-detection" class="btn btn-primary">Test Comet Detection</button>
                <button id="scan-comet-patterns" class="btn btn-warning">Scan for Comet Patterns</button>
                <div id="comet-status" style="margin-top: 10px;">
                    <span class="status info">Monitoring for Comet agent...</span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-overlays">0</div>
                <div class="stat-label">Total Overlays</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="high-zindex">0</div>
                <div class="stat-label">High Z-Index (>1000)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="suspicious-overlays">0</div>
                <div class="stat-label">Suspicious Overlays</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverage-percent">0%</div>
                <div class="stat-label">Screen Coverage</div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Detection Radar</h3>
                    <p class="card-subtitle">Real-time overlay detection feed</p>
                </div>
                <div class="detection-radar" id="detection-radar">
                    <div><span class="radar-blip"></span>[INIT] Overlay detector initialized</div>
                    <div><span class="radar-blip"></span>[INFO] Scanning for overlays and high z-index elements...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üó∫Ô∏è Overlay Heatmap</h3>
                    <p class="card-subtitle">Visual representation of overlay positions</p>
                </div>
                <div class="overlay-heatmap" id="overlay-heatmap">
                    <!-- Heatmap points will be added here -->
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìã Detected Overlays</h3>
                <p class="card-subtitle">Detailed analysis of found overlay elements</p>
            </div>
            <div id="overlay-list">
                <div class="overlay-card">
                    <h4>üîç No overlays detected yet</h4>
                    <p>Click "Scan Current Overlays" to analyze the page</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìê Z-Index Analysis</h3>
                <p class="card-subtitle">Distribution of z-index values across page elements</p>
            </div>
            <div class="z-index-meter">
                <span>Low (0-100)</span>
                <div class="z-meter-bar">
                    <div class="z-meter-fill" id="z-meter-low"></div>
                    <div class="z-meter-label" id="z-label-low">0</div>
                </div>
                <span>High (1000+)</span>
            </div>
            <div id="z-index-details"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üß™ Comet Agent Test Area</h3>
                <p class="card-subtitle">Testing ground for Perplexity Comet detection patterns</p>
            </div>
            <div class="comet-test-area" id="comet-test-area">
                <p>This area will show Comet agent detection tests</p>
                <button id="inject-comet-overlay" class="btn btn-warning">Inject Comet-style Overlay</button>
                <button id="test-style-override" class="btn btn-warning">Test Style Override</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìä Coverage Analysis</h3>
                <p class="card-subtitle">Visual representation of screen coverage by overlays</p>
            </div>
            <div class="coverage-grid" id="coverage-grid">
                <!-- Grid cells will be generated by JavaScript -->
            </div>
            <div id="coverage-details">
                <p>Coverage grid shows which parts of the screen are covered by overlay elements</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üß™ Test Overlay Generation</h3>
                <p class="card-subtitle">Create test overlays to verify detection capabilities</p>
            </div>
            <div class="scan-controls">
                <button id="test-fullscreen-overlay" class="btn btn-warning">Test: Fullscreen Overlay</button>
                <button id="test-high-zindex" class="btn btn-warning">Test: High Z-Index</button>
                <button id="test-transparent-overlay" class="btn btn-warning">Test: Transparent Overlay</button>
                <button id="test-ai-agent-overlay" class="btn btn-warning">Test: AI Agent Pattern</button>
                <button id="clear-test-overlays" class="btn btn-secondary">Clear Test Overlays</button>
            </div>
        </div>
    </div>

    <script src="../js/ai-detector.js"></script>
    <script>
        let detectionActive = false;
        let continuousScanning = true;
        let detectedOverlays = [];
        let scanInterval = null;
        let testOverlays = [];

        // Initialize overlay detector
        function initializeOverlayDetector() {
            setupEventListeners();
            generateCoverageGrid();
            startContinuousScanning();
            updateStats();
            logToRadar('Overlay detector initialized', 'info');
        }

        function setupEventListeners() {
            document.getElementById('start-detection').addEventListener('click', startDetection);
            document.getElementById('stop-detection').addEventListener('click', stopDetection);
            document.getElementById('scan-current').addEventListener('click', scanCurrentOverlays);
            document.getElementById('highlight-overlays').addEventListener('click', highlightOverlays);
            document.getElementById('export-overlay-data').addEventListener('click', exportOverlayData);
            document.getElementById('continuous-scan').addEventListener('change', toggleContinuousScanning);

            // Comet detection
            document.getElementById('test-comet-detection').addEventListener('click', testCometDetection);
            document.getElementById('scan-comet-patterns').addEventListener('click', scanCometPatterns);
            document.getElementById('inject-comet-overlay').addEventListener('click', injectCometOverlay);
            document.getElementById('test-style-override').addEventListener('click', testStyleOverride);

            // Test overlays
            document.getElementById('test-fullscreen-overlay').addEventListener('click', testFullscreenOverlay);
            document.getElementById('test-high-zindex').addEventListener('click', testHighZIndex);
            document.getElementById('test-transparent-overlay').addEventListener('click', testTransparentOverlay);
            document.getElementById('test-ai-agent-overlay').addEventListener('click', testAIAgentOverlay);
            document.getElementById('clear-test-overlays').addEventListener('click', clearTestOverlays);
        }

        function startDetection() {
            detectionActive = true;
            updateDetectorStatus();
            logToRadar('Overlay detection started', 'success');
            scanCurrentOverlays();
        }

        function stopDetection() {
            detectionActive = false;
            updateDetectorStatus();
            logToRadar('Overlay detection stopped', 'warning');
        }

        function scanCurrentOverlays() {
            detectedOverlays = [];
            const allElements = document.querySelectorAll('*');
            let highZIndexCount = 0;
            let suspiciousCount = 0;
            let totalCoverage = 0;

            allElements.forEach(element => {
                const style = window.getComputedStyle(element);
                const rect = element.getBoundingClientRect();
                const zIndex = parseInt(style.zIndex) || 0;

                // Check for overlay characteristics
                if (isOverlayElement(element, style, rect)) {
                    const overlayInfo = analyzeOverlay(element, style, rect);
                    detectedOverlays.push(overlayInfo);

                    if (overlayInfo.suspicious) {
                        suspiciousCount++;
                    }

                    totalCoverage += overlayInfo.coverage;
                    addToHeatmap(overlayInfo);
                }

                // Count high z-index elements
                if (zIndex > 1000) {
                    highZIndexCount++;
                }
            });

            // Update statistics
            document.getElementById('total-overlays').textContent = detectedOverlays.length;
            document.getElementById('high-zindex').textContent = highZIndexCount;
            document.getElementById('suspicious-overlays').textContent = suspiciousCount;
            document.getElementById('coverage-percent').textContent = Math.round(totalCoverage) + '%';

            updateOverlayList();
            updateZIndexAnalysis();
            updateCoverageGrid();
            
            logToRadar(`Scan complete: ${detectedOverlays.length} overlays found`, 'info');
            if (suspiciousCount > 0) {
                logToRadar(`‚ö†Ô∏è ${suspiciousCount} suspicious overlays detected!`, 'danger');
            }
        }

        function isOverlayElement(element, style, rect) {
            // Check if element has overlay characteristics
            const position = style.position;
            const zIndex = parseInt(style.zIndex) || 0;
            const viewportArea = window.innerWidth * window.innerHeight;
            const elementArea = rect.width * rect.height;
            const coverage = (elementArea / viewportArea) * 100;

            return (
                (position === 'fixed' || position === 'absolute') &&
                (zIndex > 100 || coverage > 10) &&
                rect.width > 0 && rect.height > 0
            );
        }

        function analyzeOverlay(element, style, rect) {
            const viewportArea = window.innerWidth * window.innerHeight;
            const elementArea = rect.width * rect.height;
            const coverage = (elementArea / viewportArea) * 100;
            const zIndex = parseInt(style.zIndex) || 0;

            const overlay = {
                element: element,
                tagName: element.tagName,
                id: element.id,
                className: element.className,
                position: style.position,
                zIndex: zIndex,
                coverage: coverage,
                rect: rect,
                opacity: parseFloat(style.opacity) || 1,
                pointerEvents: style.pointerEvents,
                visibility: style.visibility,
                display: style.display,
                suspicious: false,
                suspiciousReasons: [],
                riskLevel: 'low'
            };

            // Analyze for suspicious characteristics
            if (coverage > 50) {
                overlay.suspicious = true;
                overlay.suspiciousReasons.push('Large screen coverage');
                overlay.riskLevel = 'high';
            }

            if (zIndex > 9999) {
                overlay.suspicious = true;
                overlay.suspiciousReasons.push('Extremely high z-index');
                overlay.riskLevel = 'high';
            }

            if (overlay.opacity < 0.1 && overlay.pointerEvents !== 'none') {
                overlay.suspicious = true;
                overlay.suspiciousReasons.push('Nearly invisible but interactive');
                overlay.riskLevel = 'medium';
            }

            // Check for AI agent patterns
            const agentPatterns = [
                'pplx-agent-overlay',
                'comet-agent',
                'ai-assistant',
                'stop-button',
                'agent-control',
                'automation-overlay'
            ];

            agentPatterns.forEach(pattern => {
                if (overlay.id.includes(pattern) || overlay.className.includes(pattern)) {
                    overlay.suspicious = true;
                    overlay.suspiciousReasons.push(`AI agent pattern: ${pattern}`);
                    overlay.riskLevel = 'high';
                }
            });

            return overlay;
        }

        function updateOverlayList() {
            const container = document.getElementById('overlay-list');
            container.innerHTML = '';

            if (detectedOverlays.length === 0) {
                container.innerHTML = `
                    <div class="overlay-card">
                        <h4>üîç No overlays detected</h4>
                        <p>No overlay elements found on the current page</p>
                    </div>
                `;
                return;
            }

            detectedOverlays.forEach((overlay, index) => {
                const card = document.createElement('div');
                card.className = `overlay-card ${overlay.riskLevel === 'high' ? 'high-risk' : overlay.riskLevel === 'medium' ? 'medium-risk' : ''}`;

                const riskIcon = overlay.riskLevel === 'high' ? 'üö®' : overlay.riskLevel === 'medium' ? '‚ö†Ô∏è' : '‚úÖ';
                
                card.innerHTML = `
                    <h4>${riskIcon} ${overlay.tagName} ${overlay.id ? `#${overlay.id}` : ''}</h4>
                    <div class="overlay-preview" id="preview-${index}"></div>
                    <div class="extension-details">
                        <div class="extension-detail">
                            <strong>Position:</strong> ${overlay.position}
                        </div>
                        <div class="extension-detail">
                            <strong>Z-Index:</strong> ${overlay.zIndex}
                        </div>
                        <div class="extension-detail">
                            <strong>Coverage:</strong> ${overlay.coverage.toFixed(1)}%
                        </div>
                        <div class="extension-detail">
                            <strong>Opacity:</strong> ${overlay.opacity}
                        </div>
                        ${overlay.suspicious ? `
                            <div class="extension-detail">
                                <strong>‚ö†Ô∏è Suspicious:</strong> ${overlay.suspiciousReasons.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;

                container.appendChild(card);

                // Add visual preview
                setTimeout(() => {
                    createOverlayPreview(index, overlay);
                }, 100);
            });
        }

        function createOverlayPreview(index, overlay) {
            const preview = document.getElementById(`preview-${index}`);
            if (!preview) return;

            const previewRect = preview.getBoundingClientRect();
            const scaleX = previewRect.width / window.innerWidth;
            const scaleY = previewRect.height / window.innerHeight;

            const overlayElement = document.createElement('div');
            overlayElement.className = 'overlay-element';
            overlayElement.style.left = (overlay.rect.left * scaleX) + 'px';
            overlayElement.style.top = (overlay.rect.top * scaleY) + 'px';
            overlayElement.style.width = (overlay.rect.width * scaleX) + 'px';
            overlayElement.style.height = (overlay.rect.height * scaleY) + 'px';
            overlayElement.textContent = `z:${overlay.zIndex}`;

            preview.appendChild(overlayElement);
        }

        function addToHeatmap(overlay) {
            const heatmap = document.getElementById('overlay-heatmap');
            const heatmapRect = heatmap.getBoundingClientRect();
            const scaleX = heatmapRect.width / window.innerWidth;
            const scaleY = heatmapRect.height / window.innerHeight;

            const point = document.createElement('div');
            point.className = 'heatmap-point';
            point.style.left = (overlay.rect.left * scaleX + overlay.rect.width * scaleX / 2) + 'px';
            point.style.top = (overlay.rect.top * scaleY + overlay.rect.height * scaleY / 2) + 'px';
            
            if (overlay.suspicious) {
                point.style.background = '#ff6b6b';
                point.style.transform = 'translate(-50%, -50%) scale(1.5)';
            }

            heatmap.appendChild(point);

            // Remove old points if too many
            if (heatmap.children.length > 50) {
                heatmap.removeChild(heatmap.firstChild);
            }
        }

        function updateZIndexAnalysis() {
            const allElements = document.querySelectorAll('*');
            const zIndexDistribution = { low: 0, medium: 0, high: 0, extreme: 0 };
            const highZElements = [];

            allElements.forEach(element => {
                const zIndex = parseInt(window.getComputedStyle(element).zIndex) || 0;
                
                if (zIndex <= 100) zIndexDistribution.low++;
                else if (zIndex <= 1000) zIndexDistribution.medium++;
                else if (zIndex <= 10000) zIndexDistribution.high++;
                else zIndexDistribution.extreme++;

                if (zIndex > 1000) {
                    highZElements.push({
                        element: element,
                        zIndex: zIndex,
                        tag: element.tagName,
                        id: element.id,
                        class: element.className
                    });
                }
            });

            // Update z-index meter
            const total = Object.values(zIndexDistribution).reduce((a, b) => a + b, 0);
            const highPercentage = ((zIndexDistribution.high + zIndexDistribution.extreme) / total) * 100;
            
            document.getElementById('z-meter-low').style.width = highPercentage + '%';
            document.getElementById('z-label-low').textContent = Math.round(highPercentage) + '%';

            // Update details
            const detailsContainer = document.getElementById('z-index-details');
            detailsContainer.innerHTML = `
                <div class="grid grid-2">
                    <div>
                        <h4>Distribution:</h4>
                        <p>Low (0-100): ${zIndexDistribution.low}</p>
                        <p>Medium (101-1000): ${zIndexDistribution.medium}</p>
                        <p>High (1001-10000): ${zIndexDistribution.high}</p>
                        <p>Extreme (10000+): ${zIndexDistribution.extreme}</p>
                    </div>
                    <div>
                        <h4>High Z-Index Elements:</h4>
                        ${highZElements.slice(0, 5).map(el => 
                            `<p>${el.tag} (z:${el.zIndex}) ${el.id ? '#' + el.id : ''}</p>`
                        ).join('')}
                        ${highZElements.length > 5 ? `<p>...and ${highZElements.length - 5} more</p>` : ''}
                    </div>
                </div>
            `;
        }

        function generateCoverageGrid() {
            const grid = document.getElementById('coverage-grid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('div');
                cell.className = 'coverage-cell';
                cell.dataset.index = i;
                grid.appendChild(cell);
            }
        }

        function updateCoverageGrid() {
            const cells = document.querySelectorAll('.coverage-cell');
            cells.forEach(cell => cell.classList.remove('covered'));

            detectedOverlays.forEach(overlay => {
                const gridX = Math.floor((overlay.rect.left / window.innerWidth) * 10);
                const gridY = Math.floor((overlay.rect.top / window.innerHeight) * 10);
                const gridW = Math.ceil((overlay.rect.width / window.innerWidth) * 10);
                const gridH = Math.ceil((overlay.rect.height / window.innerHeight) * 10);

                for (let y = gridY; y < Math.min(gridY + gridH, 10); y++) {
                    for (let x = gridX; x < Math.min(gridX + gridW, 10); x++) {
                        const index = y * 10 + x;
                        if (index < cells.length) {
                            cells[index].classList.add('covered');
                        }
                    }
                }
            });
        }

        function highlightOverlays() {
            // Remove existing highlights
            document.querySelectorAll('.overlay-highlight').forEach(el => el.remove());

            detectedOverlays.forEach(overlay => {
                const highlight = document.createElement('div');
                highlight.className = 'overlay-highlight';
                highlight.style.cssText = `
                    position: fixed;
                    pointer-events: none;
                    border: 3px solid ${overlay.suspicious ? '#ff6b6b' : '#4dabf7'};
                    background: ${overlay.suspicious ? 'rgba(255, 107, 107, 0.1)' : 'rgba(77, 171, 247, 0.1)'};
                    z-index: 999999;
                    left: ${overlay.rect.left}px;
                    top: ${overlay.rect.top}px;
                    width: ${overlay.rect.width}px;
                    height: ${overlay.rect.height}px;
                `;
                document.body.appendChild(highlight);
            });

            // Remove highlights after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('.overlay-highlight').forEach(el => el.remove());
            }, 5000);

            logToRadar('Overlays highlighted for 5 seconds', 'info');
        }

        function startContinuousScanning() {
            if (scanInterval) clearInterval(scanInterval);
            
            scanInterval = setInterval(() => {
                if (continuousScanning && detectionActive) {
                    scanCurrentOverlays();
                }
            }, 3000);
        }

        function toggleContinuousScanning() {
            continuousScanning = document.getElementById('continuous-scan').checked;
            logToRadar(`Continuous scanning ${continuousScanning ? 'enabled' : 'disabled'}`, 'info');
        }

        function updateDetectorStatus() {
            const statusElement = document.getElementById('detector-status');
            if (detectionActive) {
                statusElement.textContent = 'Active';
                statusElement.className = 'status safe';
            } else {
                statusElement.textContent = 'Inactive';
                statusElement.className = 'status';
            }
        }

        function logToRadar(message, level = 'info') {
            const radar = document.getElementById('detection-radar');
            const timestamp = new Date().toLocaleTimeString();
            const blipClass = level === 'danger' ? 'radar-blip threat' : 'radar-blip';
            const levelPrefix = level === 'danger' ? '[THREAT]' : level === 'warning' ? '[WARN]' : level === 'success' ? '[OK]' : '[INFO]';
            
            const line = document.createElement('div');
            line.innerHTML = `<span class="${blipClass}"></span>[${timestamp}] ${levelPrefix} ${message}`;
            line.style.color = level === 'danger' ? '#ff6b6b' : level === 'warning' ? '#ffd93d' : level === 'success' ? '#6bcf7f' : '#00ff00';
            
            radar.appendChild(line);
            radar.scrollTop = radar.scrollHeight;

            // Keep only last 50 lines
            while (radar.children.length > 50) {
                radar.removeChild(radar.firstChild);
            }
        }

        // Comet detection functions
        function testCometDetection() {
            logToRadar('Testing Perplexity Comet detection...', 'info');
            
            // Check for Comet browser environment
            if (window.location.protocol === 'comet:') {
                logToRadar('üö® Comet browser protocol detected!', 'danger');
                updateCometStatus('Comet browser detected', 'danger');
                return;
            }

            // Check for Comet-specific elements
            const cometIndicators = [
                '#pplx-agent-overlay-stop-button',
                '.pplx-agent-overlay',
                '[id*="comet-agent"]',
                '[class*="comet-agent"]'
            ];

            let cometDetected = false;
            cometIndicators.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    cometDetected = true;
                    logToRadar(`üö® Comet element detected: ${selector}`, 'danger');
                }
            });

            // Test for Comet style override
            testCometStyleOverride();

            if (!cometDetected) {
                logToRadar('No Comet agent detected', 'info');
                updateCometStatus('No Comet agent detected', 'safe');
            } else {
                updateCometStatus('Comet agent detected!', 'danger');
            }
        }

        function testCometStyleOverride() {
            const testDiv = document.createElement('div');
            testDiv.id = 'pplx-agent-overlay-stop-button';
            testDiv.style.cssText = `
                width: 200px;
                height: 200px;
                background-color: blue;
                position: absolute;
                top: -9999px;
                left: -9999px;
            `;
            document.body.appendChild(testDiv);

            setTimeout(() => {
                const computedColor = window.getComputedStyle(testDiv).backgroundColor;
                if (computedColor === 'rgb(255, 254, 251)') {
                    logToRadar('üö® Comet style override detected!', 'danger');
                    updateCometStatus('Comet style override detected', 'danger');
                } else {
                    logToRadar('No Comet style override detected', 'info');
                }
                document.body.removeChild(testDiv);
            }, 200);
        }

        function scanCometPatterns() {
            logToRadar('Scanning for Comet agent patterns...', 'info');
            
            const patterns = [
                'pplx-agent-overlay',
                'comet-agent',
                'stop-comet-assistant'
            ];

            let patternsFound = 0;
            patterns.forEach(pattern => {
                const elements = document.querySelectorAll(`[id*="${pattern}"], [class*="${pattern}"]`);
                if (elements.length > 0) {
                    patternsFound++;
                    logToRadar(`Pattern found: ${pattern} (${elements.length} elements)`, 'warning');
                }
            });

            if (patternsFound > 0) {
                updateCometStatus(`${patternsFound} Comet patterns found`, 'warning');
            } else {
                updateCometStatus('No Comet patterns found', 'safe');
            }
        }

        function updateCometStatus(message, level) {
            const status = document.getElementById('comet-status');
            status.innerHTML = `<span class="status ${level}">${message}</span>`;
        }

        // Test overlay functions
        function testFullscreenOverlay() {
            const overlay = createTestOverlay({
                position: 'fixed',
                top: '0',
                left: '0',
                width: '100%',
                height: '100%',
                background: 'rgba(255, 0, 0, 0.2)',
                zIndex: '99999',
                pointerEvents: 'none'
            }, 'Fullscreen Test Overlay');
            
            logToRadar('Test: Fullscreen overlay created', 'warning');
        }

        function testHighZIndex() {
            const overlay = createTestOverlay({
                position: 'fixed',
                top: '50px',
                right: '50px',
                width: '200px',
                height: '100px',
                background: 'rgba(255, 255, 0, 0.8)',
                zIndex: '999999',
                border: '2px solid red'
            }, 'High Z-Index Test');
            
            logToRadar('Test: High z-index overlay created', 'warning');
        }

        function testTransparentOverlay() {
            const overlay = createTestOverlay({
                position: 'fixed',
                top: '0',
                left: '0',
                width: '100%',
                height: '100%',
                background: 'rgba(0, 0, 0, 0.01)',
                zIndex: '50000',
                pointerEvents: 'all',
                cursor: 'crosshair'
            }, 'Invisible Overlay');
            
            logToRadar('Test: Transparent overlay created', 'warning');
        }

        function testAIAgentOverlay() {
            const overlay = createTestOverlay({
                position: 'fixed',
                top: '20px',
                left: '20px',
                width: '300px',
                height: '60px',
                background: 'rgba(0, 0, 255, 0.8)',
                zIndex: '99999',
                color: 'white',
                padding: '10px',
                borderRadius: '5px'
            }, 'Stop AI Assistant');
            
            overlay.id = 'pplx-agent-overlay-stop-button';
            overlay.className = 'comet-agent-overlay';
            
            logToRadar('Test: AI agent overlay pattern created', 'danger');
        }

        function injectCometOverlay() {
            const testArea = document.getElementById('comet-test-area');
            const overlay = document.createElement('div');
            overlay.className = 'test-overlay';
            overlay.style.cssText = `
                top: 10px;
                left: 10px;
                right: 10px;
                bottom: 10px;
                z-index: 100;
            `;
            overlay.textContent = 'Comet Agent Overlay Simulation';
            overlay.id = 'pplx-agent-overlay-test';
            
            testArea.appendChild(overlay);
            setTimeout(() => testArea.removeChild(overlay), 3000);
            
            logToRadar('Comet overlay injected in test area', 'warning');
        }

        function testStyleOverride() {
            const testElement = document.createElement('div');
            testElement.id = 'pplx-agent-overlay-stop-button';
            testElement.style.cssText = `
                position: absolute;
                top: -9999px;
                width: 100px;
                height: 100px;
                background: blue;
            `;
            document.body.appendChild(testElement);

            // Override styles (simulating Comet behavior)
            setTimeout(() => {
                Object.assign(testElement.style, {
                    position: 'fixed',
                    top: '50px',
                    left: '50px',
                    background: 'rgb(255, 254, 251)',
                    opacity: '0.8',
                    cursor: 'progress'
                });
                
                setTimeout(() => {
                    if (testElement.parentNode) {
                        document.body.removeChild(testElement);
                    }
                }, 2000);
            }, 500);
            
            logToRadar('Style override test initiated', 'warning');
        }

        function createTestOverlay(styles, text) {
            const overlay = document.createElement('div');
            overlay.className = 'test-overlay-element';
            overlay.textContent = text;
            
            Object.assign(overlay.style, styles);
            
            document.body.appendChild(overlay);
            testOverlays.push(overlay);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (overlay.parentNode) {
                    document.body.removeChild(overlay);
                    const index = testOverlays.indexOf(overlay);
                    if (index > -1) testOverlays.splice(index, 1);
                }
            }, 5000);
            
            return overlay;
        }

        function clearTestOverlays() {
            testOverlays.forEach(overlay => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            });
            testOverlays = [];
            
            // Also clear any test overlays in the test area
            document.querySelectorAll('.test-overlay').forEach(el => el.remove());
            
            logToRadar('All test overlays cleared', 'info');
        }

        function exportOverlayData() {
            const data = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalOverlays: detectedOverlays.length,
                    suspiciousOverlays: detectedOverlays.filter(o => o.suspicious).length,
                    highZIndexElements: detectedOverlays.filter(o => o.zIndex > 1000).length
                },
                overlays: detectedOverlays.map(overlay => ({
                    tagName: overlay.tagName,
                    id: overlay.id,
                    className: overlay.className,
                    position: overlay.position,
                    zIndex: overlay.zIndex,
                    coverage: overlay.coverage,
                    opacity: overlay.opacity,
                    suspicious: overlay.suspicious,
                    suspiciousReasons: overlay.suspiciousReasons,
                    riskLevel: overlay.riskLevel
                })),
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `overlay-detection-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logToRadar('Overlay data exported', 'success');
        }

        function updateStats() {
            // Initial stats update
            scanCurrentOverlays();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeOverlayDetector();
            // Auto-start detection
            setTimeout(startDetection, 1000);
        });
    </script>
</body>
</html>
