<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extension Detector - AI Agent Detection Framework</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .extension-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--secondary-color);
        }
        
        .extension-card.detected {
            border-left-color: var(--accent-color);
            background: #fdf2f2;
        }
        
        .extension-card.ai-agent {
            border-left-color: var(--warning-color);
            background: #fff8e1;
        }
        
        .extension-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .extension-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .extension-risk {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .risk-low {
            background: var(--success-color);
            color: white;
        }
        
        .risk-medium {
            background: var(--warning-color);
            color: white;
        }
        
        .risk-high {
            background: var(--accent-color);
            color: white;
        }
        
        .extension-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .extension-detail {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }
        
        .extension-detail strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
        }
        
        .scan-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .scan-progress {
            width: 100%;
            margin: 10px 0;
        }
        
        .script-analysis {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .manifest-viewer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .permission-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .permission-tag {
            background: var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .permission-tag.dangerous {
            background: var(--accent-color);
        }
        
        .ai-agent-indicators {
            background: linear-gradient(135deg, #ffd93d, #ff6b6b);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .indicator-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .indicator-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
        }
        
        .indicator-item.detected {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">üß© Extension Detector</div>
            <div>
                <span class="status" id="scan-status">Ready</span>
            </div>
        </div>
    </header>

    <nav>
        <div class="nav-container">
            <ul class="nav-menu">
                <li class="nav-item"><a href="../index.html" class="nav-link">Dashboard</a></li>
                <li class="nav-item"><a href="dom-monitor.html" class="nav-link">DOM Monitor</a></li>
                <li class="nav-item"><a href="extension-detector.html" class="nav-link active">Extensions</a></li>
                <li class="nav-item"><a href="stylesheet-monitor.html" class="nav-link">Stylesheets</a></li>
                <li class="nav-item"><a href="overlay-detector.html" class="nav-link">Overlays</a></li>
                <li class="nav-item"><a href="live-dashboard.html" class="nav-link">Live Dashboard</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üß© Browser Extension Detection</h2>
                <p class="card-subtitle">Identify browser extensions and content scripts, particularly AI agents</p>
            </div>
            
            <div class="scan-controls">
                <button id="start-scan" class="btn btn-primary">Start Extension Scan</button>
                <button id="deep-scan" class="btn btn-warning">Deep Analysis</button>
                <button id="monitor-injections" class="btn btn-success">Monitor Injections</button>
                <button id="export-report" class="btn btn-secondary">Export Report</button>
                <label>
                    <input type="checkbox" id="auto-scan" checked> Auto-scan every 10s
                </label>
            </div>
            
            <div class="scan-progress" id="scan-progress-container" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="scan-progress"></div>
                </div>
                <div id="scan-status-text">Scanning...</div>
            </div>
        </div>

        <div class="ai-agent-indicators">
            <h3>ü§ñ AI Agent Detection Indicators</h3>
            <p>Checking for known AI agent patterns and browser automation signatures</p>
            <div class="indicator-list" id="ai-indicators">
                <div class="indicator-item" data-check="perplexity-comet">
                    <strong>Perplexity Comet</strong>
                    <div>Checking for Comet browser signatures...</div>
                </div>
                <div class="indicator-item" data-check="webdriver">
                    <strong>WebDriver</strong>
                    <div>Detecting automation frameworks...</div>
                </div>
                <div class="indicator-item" data-check="headless">
                    <strong>Headless Browser</strong>
                    <div>Checking for headless indicators...</div>
                </div>
                <div class="indicator-item" data-check="automation">
                    <strong>Automation Tools</strong>
                    <div>Scanning for Playwright, Puppeteer...</div>
                </div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Extension Summary</h3>
                    <p class="card-subtitle">Overview of detected extensions</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-extensions">0</div>
                        <div class="stat-label">Total Extensions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="content-scripts">0</div>
                        <div class="stat-label">Content Scripts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="suspicious-extensions">0</div>
                        <div class="stat-label">Suspicious</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ai-agents">0</div>
                        <div class="stat-label">AI Agents</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üîç Real-time Monitoring</h3>
                    <p class="card-subtitle">Live extension activity feed</p>
                </div>
                <div class="script-analysis" id="activity-feed">
                    <div>[INIT] Extension detector initialized</div>
                    <div>[INFO] Ready to scan for extensions</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìã Detected Extensions</h3>
                <p class="card-subtitle">Detailed information about found extensions</p>
            </div>
            <div id="extension-list">
                <div class="extension-card">
                    <div class="extension-header">
                        <div class="extension-name">No extensions detected yet</div>
                        <div class="extension-risk risk-low">Safe</div>
                    </div>
                    <div>Click "Start Extension Scan" to begin detection</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üß™ Test Extension Detection</h3>
                <p class="card-subtitle">Simulate various extension behaviors for testing</p>
            </div>
            <div class="scan-controls">
                <button id="test-content-script" class="btn btn-warning">Test: Content Script</button>
                <button id="test-ai-agent" class="btn btn-warning">Test: AI Agent Pattern</button>
                <button id="test-dom-injection" class="btn btn-warning">Test: DOM Injection</button>
                <button id="test-style-override" class="btn btn-warning">Test: Style Override</button>
                <button id="test-global-var" class="btn btn-warning">Test: Global Variables</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üî¨ Technical Analysis</h3>
                <p class="card-subtitle">Deep technical analysis of extension behavior</p>
            </div>
            <div class="script-analysis" id="technical-analysis">
                <div>// Technical analysis will appear here</div>
                <div>// Click "Deep Analysis" to start</div>
            </div>
        </div>
    </div>

    <script src="../js/ai-detector.js"></script>
    <script>
        let scanInProgress = false;
        let monitoringActive = false;
        let detectedExtensions = [];
        let contentScripts = [];
        let aiAgents = [];
        let autoScanInterval = null;

        // Known AI agent patterns and extension IDs
        const AI_AGENT_PATTERNS = {
            'perplexity-comet': {
                name: 'Perplexity Comet',
                indicators: [
                    'comet-extension://',
                    'pplx-agent-overlay',
                    'comet-agent',
                    'window.comet'
                ],
                extensionId: 'npclhjbddhklpbnacpjloidibaggcgon'
            },
            'openai-operator': {
                name: 'OpenAI Operator',
                indicators: [
                    'Signature-Agent',
                    'openai-operator',
                    'chatgpt-agent'
                ]
            },
            'browserbase': {
                name: 'Browserbase',
                indicators: [
                    'window.playwright__binding',
                    'browserbase-session'
                ]
            }
        };

        const AUTOMATION_INDICATORS = [
            'navigator.webdriver',
            'window.callPhantom',
            'window._phantom',
            'window.phantom',
            'window.Buffer',
            'window.emit',
            'window.spawn',
            'window.playwright',
            'window.puppeteer',
            'window.chrome.runtime',
            'window.browser.runtime'
        ];

        // Initialize extension detector
        function initializeExtensionDetector() {
            setupEventListeners();
            checkAIAgentIndicators();
            updateStats();
            logActivity('Extension detector initialized', 'info');

            // Start auto-scan if enabled
            const autoScan = document.getElementById('auto-scan');
            if (autoScan.checked) {
                startAutoScan();
            }
        }

        function setupEventListeners() {
            document.getElementById('start-scan').addEventListener('click', startExtensionScan);
            document.getElementById('deep-scan').addEventListener('click', performDeepAnalysis);
            document.getElementById('monitor-injections').addEventListener('click', toggleInjectionMonitoring);
            document.getElementById('export-report').addEventListener('click', exportReport);
            document.getElementById('auto-scan').addEventListener('change', toggleAutoScan);

            // Test buttons
            document.getElementById('test-content-script').addEventListener('click', testContentScript);
            document.getElementById('test-ai-agent').addEventListener('click', testAIAgent);
            document.getElementById('test-dom-injection').addEventListener('click', testDOMInjection);
            document.getElementById('test-style-override').addEventListener('click', testStyleOverride);
            document.getElementById('test-global-var').addEventListener('click', testGlobalVariable);
        }

        function startExtensionScan() {
            if (scanInProgress) return;

            scanInProgress = true;
            updateScanStatus('Scanning');
            showProgress(true);
            logActivity('Starting extension scan...', 'info');

            // Reset data
            detectedExtensions = [];
            contentScripts = [];
            aiAgents = [];

            // Perform scan steps
            performScanSteps();
        }

        async function performScanSteps() {
            const steps = [
                { name: 'Scanning DOM for extension scripts', action: scanDOMScripts },
                { name: 'Checking for extension globals', action: checkExtensionGlobals },
                { name: 'Analyzing content scripts', action: analyzeContentScripts },
                { name: 'Detecting AI agent patterns', action: detectAIAgentPatterns },
                { name: 'Checking automation indicators', action: checkAutomationIndicators },
                { name: 'Finalizing report', action: finalizeReport }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                updateProgress((i / steps.length) * 100, step.name);
                logActivity(step.name, 'info');
                
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate processing time
                await step.action();
            }

            updateProgress(100, 'Scan complete');
            scanInProgress = false;
            updateScanStatus('Complete');
            showProgress(false);
            updateExtensionList();
            updateStats();
        }

        function scanDOMScripts() {
            const scripts = Array.from(document.scripts);
            
            scripts.forEach(script => {
                if (script.src) {
                    // Check for extension URLs
                    if (script.src.includes('extension://') || script.src.includes('chrome-extension://')) {
                        const extensionInfo = {
                            type: 'content_script',
                            url: script.src,
                            id: extractExtensionId(script.src),
                            detected: new Date().toISOString()
                        };
                        
                        contentScripts.push(extensionInfo);
                        logActivity(`Content script detected: ${script.src}`, 'warning');
                    }
                }
            });

            // Check for injected script elements
            const injectedScripts = scripts.filter(script => 
                !script.src && script.textContent && script.textContent.length > 100
            );

            injectedScripts.forEach(script => {
                const content = script.textContent;
                
                // Check for extension patterns in script content
                Object.keys(AI_AGENT_PATTERNS).forEach(agentKey => {
                    const agent = AI_AGENT_PATTERNS[agentKey];
                    agent.indicators.forEach(indicator => {
                        if (content.includes(indicator)) {
                            logActivity(`AI agent pattern found in script: ${indicator}`, 'danger');
                            aiAgents.push({
                                agent: agent.name,
                                indicator: indicator,
                                source: 'injected_script'
                            });
                        }
                    });
                });
            });
        }

        function checkExtensionGlobals() {
            // Check for extension-specific global variables
            const extensionGlobals = [
                'chrome.runtime',
                'browser.runtime',
                'chrome.extension',
                'browser.extension'
            ];

            extensionGlobals.forEach(global => {
                try {
                    if (eval(global)) {
                        detectedExtensions.push({
                            name: global,
                            type: 'global_api',
                            riskLevel: 'medium',
                            details: `Extension API detected: ${global}`
                        });
                        logActivity(`Extension API detected: ${global}`, 'warning');
                    }
                } catch (e) {
                    // Global doesn't exist
                }
            });
        }

        function analyzeContentScripts() {
            // Analyze detected content scripts for suspicious behavior
            contentScripts.forEach(script => {
                const analysis = {
                    ...script,
                    riskLevel: 'low',
                    analysis: []
                };

                // Check for AI agent extension IDs
                Object.keys(AI_AGENT_PATTERNS).forEach(agentKey => {
                    const agent = AI_AGENT_PATTERNS[agentKey];
                    if (agent.extensionId && script.id === agent.extensionId) {
                        analysis.riskLevel = 'high';
                        analysis.analysis.push(`Identified as ${agent.name}`);
                        analysis.isAIAgent = true;
                        
                        aiAgents.push({
                            agent: agent.name,
                            indicator: 'extension_id',
                            source: 'content_script',
                            extensionId: script.id
                        });
                    }
                });

                detectedExtensions.push({
                    name: analysis.isAIAgent ? AI_AGENT_PATTERNS[Object.keys(AI_AGENT_PATTERNS).find(k => 
                        AI_AGENT_PATTERNS[k].extensionId === script.id
                    )].name : `Extension ${script.id}`,
                    type: 'content_script',
                    riskLevel: analysis.riskLevel,
                    details: script.url,
                    analysis: analysis.analysis,
                    isAIAgent: analysis.isAIAgent
                });
            });
        }

        function detectAIAgentPatterns() {
            // Check for specific AI agent patterns in the DOM
            Object.keys(AI_AGENT_PATTERNS).forEach(agentKey => {
                const agent = AI_AGENT_PATTERNS[agentKey];
                let detected = false;

                agent.indicators.forEach(indicator => {
                    // Check for DOM elements with indicator patterns
                    if (indicator.startsWith('window.')) {
                        try {
                            if (eval(indicator)) {
                                detected = true;
                                logActivity(`${agent.name} detected via global: ${indicator}`, 'danger');
                            }
                        } catch (e) {
                            // Indicator doesn't exist
                        }
                    } else {
                        // Check DOM for element patterns
                        const elements = document.querySelectorAll(`[id*="${indicator}"], [class*="${indicator}"]`);
                        if (elements.length > 0) {
                            detected = true;
                            logActivity(`${agent.name} detected via DOM: ${indicator}`, 'danger');
                        }
                    }
                });

                if (detected) {
                    aiAgents.push({
                        agent: agent.name,
                        indicator: 'pattern_match',
                        source: 'dom_analysis'
                    });

                    detectedExtensions.push({
                        name: agent.name,
                        type: 'ai_agent',
                        riskLevel: 'high',
                        details: 'AI agent detected through pattern matching',
                        isAIAgent: true
                    });
                }
            });
        }

        function checkAutomationIndicators() {
            AUTOMATION_INDICATORS.forEach(indicator => {
                try {
                    if (eval(indicator)) {
                        detectedExtensions.push({
                            name: 'Automation Framework',
                            type: 'automation',
                            riskLevel: 'high',
                            details: `Automation detected: ${indicator}`,
                            isAutomation: true
                        });
                        logActivity(`Automation framework detected: ${indicator}`, 'danger');
                    }
                } catch (e) {
                    // Indicator doesn't exist
                }
            });

            // Special checks
            if (navigator.webdriver) {
                logActivity('WebDriver detected - automated browser', 'danger');
            }

            // Check timezone (UTC often indicates automation)
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (timezone === 'UTC') {
                logActivity('UTC timezone detected (common in automation)', 'warning');
            }

            // Check for headless indicators
            if (window.outerWidth === 0 || window.outerHeight === 0) {
                logActivity('Headless browser indicators detected', 'warning');
            }
        }

        function finalizeReport() {
            logActivity(`Scan complete: ${detectedExtensions.length} extensions found`, 'success');
            
            if (aiAgents.length > 0) {
                logActivity(`‚ö†Ô∏è ${aiAgents.length} AI agent(s) detected!`, 'danger');
            }
        }

        function checkAIAgentIndicators() {
            const indicators = document.querySelectorAll('[data-check]');
            
            indicators.forEach(indicator => {
                const check = indicator.getAttribute('data-check');
                let detected = false;
                let details = '';

                switch (check) {
                    case 'perplexity-comet':
                        // Check for Comet-specific indicators
                        detected = document.querySelector('#pplx-agent-overlay-stop-button') !== null ||
                                  window.location.protocol === 'comet:' ||
                                  navigator.userAgent.includes('Comet');
                        details = detected ? 'Comet browser environment detected' : 'Not detected';
                        break;

                    case 'webdriver':
                        detected = navigator.webdriver === true;
                        details = detected ? 'WebDriver flag is true' : 'WebDriver not detected';
                        break;

                    case 'headless':
                        detected = window.outerWidth === 0 || window.outerHeight === 0 ||
                                  !window.chrome || !window.chrome.runtime;
                        details = detected ? 'Headless browser characteristics found' : 'Normal browser detected';
                        break;

                    case 'automation':
                        const automationGlobals = ['window.playwright', 'window.puppeteer', 'window.callPhantom'];
                        detected = automationGlobals.some(global => {
                            try { return eval(global); } catch { return false; }
                        });
                        details = detected ? 'Automation framework globals found' : 'No automation frameworks detected';
                        break;
                }

                indicator.querySelector('div').textContent = details;
                if (detected) {
                    indicator.classList.add('detected');
                }
            });
        }

        function updateExtensionList() {
            const container = document.getElementById('extension-list');
            container.innerHTML = '';

            if (detectedExtensions.length === 0) {
                container.innerHTML = `
                    <div class="extension-card">
                        <div class="extension-header">
                            <div class="extension-name">No extensions detected</div>
                            <div class="extension-risk risk-low">Safe</div>
                        </div>
                        <div>No browser extensions or AI agents were found during the scan.</div>
                    </div>
                `;
                return;
            }

            detectedExtensions.forEach(ext => {
                const card = document.createElement('div');
                card.className = `extension-card ${ext.isAIAgent ? 'ai-agent' : ext.riskLevel === 'high' ? 'detected' : ''}`;

                const riskClass = ext.riskLevel === 'high' ? 'risk-high' : ext.riskLevel === 'medium' ? 'risk-medium' : 'risk-low';
                const icon = ext.isAIAgent ? 'ü§ñ' : ext.type === 'automation' ? '‚öôÔ∏è' : 'üß©';

                card.innerHTML = `
                    <div class="extension-header">
                        <div class="extension-name">${icon} ${ext.name}</div>
                        <div class="extension-risk ${riskClass}">${ext.riskLevel}</div>
                    </div>
                    <div class="extension-details">
                        <div class="extension-detail">
                            <strong>Type:</strong>
                            ${ext.type.replace('_', ' ').toUpperCase()}
                        </div>
                        <div class="extension-detail">
                            <strong>Details:</strong>
                            ${ext.details}
                        </div>
                        ${ext.analysis ? `
                            <div class="extension-detail">
                                <strong>Analysis:</strong>
                                ${ext.analysis.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function updateStats() {
            document.getElementById('total-extensions').textContent = detectedExtensions.length;
            document.getElementById('content-scripts').textContent = contentScripts.length;
            document.getElementById('suspicious-extensions').textContent = 
                detectedExtensions.filter(ext => ext.riskLevel === 'high').length;
            document.getElementById('ai-agents').textContent = aiAgents.length;
        }

        function logActivity(message, level = 'info') {
            const feed = document.getElementById('activity-feed');
            const timestamp = new Date().toLocaleTimeString();
            const levelPrefix = level === 'danger' ? '[ALERT]' : level === 'warning' ? '[WARN]' : level === 'success' ? '[OK]' : '[INFO]';
            
            const line = document.createElement('div');
            line.style.color = level === 'danger' ? '#ff6b6b' : level === 'warning' ? '#ffd93d' : level === 'success' ? '#6bcf7f' : '#00ff00';
            line.textContent = `[${timestamp}] ${levelPrefix} ${message}`;
            
            feed.appendChild(line);
            feed.scrollTop = feed.scrollHeight;

            // Keep only last 50 lines
            while (feed.children.length > 50) {
                feed.removeChild(feed.firstChild);
            }
        }

        function logTechnical(message) {
            const analysis = document.getElementById('technical-analysis');
            const line = document.createElement('div');
            line.textContent = message;
            analysis.appendChild(line);
            analysis.scrollTop = analysis.scrollHeight;
        }

        function showProgress(show) {
            const container = document.getElementById('scan-progress-container');
            container.style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent, status) {
            const progressBar = document.getElementById('scan-progress');
            const statusText = document.getElementById('scan-status-text');
            
            progressBar.style.width = `${percent}%`;
            statusText.textContent = status;
        }

        function updateScanStatus(status) {
            const statusElement = document.getElementById('scan-status');
            statusElement.textContent = status;
            statusElement.className = `status ${status === 'Complete' ? 'safe' : status === 'Scanning' ? 'warning' : ''}`;
        }

        function extractExtensionId(url) {
            const match = url.match(/extension:\/\/([a-zA-Z0-9]+)/);
            return match ? match[1] : 'unknown';
        }

        function toggleAutoScan() {
            const autoScan = document.getElementById('auto-scan');
            if (autoScan.checked) {
                startAutoScan();
            } else {
                stopAutoScan();
            }
        }

        function startAutoScan() {
            if (autoScanInterval) return;
            autoScanInterval = setInterval(() => {
                if (!scanInProgress) {
                    startExtensionScan();
                }
            }, 10000);
            logActivity('Auto-scan enabled (every 10 seconds)', 'info');
        }

        function stopAutoScan() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
                logActivity('Auto-scan disabled', 'info');
            }
        }

        function performDeepAnalysis() {
            logTechnical('// Starting deep technical analysis...');
            logTechnical('');
            
            // Analyze browser environment
            logTechnical('// Browser Environment Analysis');
            logTechnical(`navigator.userAgent: "${navigator.userAgent}"`);
            logTechnical(`navigator.webdriver: ${navigator.webdriver}`);
            logTechnical(`window.chrome: ${!!window.chrome}`);
            logTechnical(`window.outerWidth: ${window.outerWidth}`);
            logTechnical(`window.outerHeight: ${window.outerHeight}`);
            logTechnical(`screen.width: ${screen.width}`);
            logTechnical(`screen.height: ${screen.height}`);
            logTechnical('');

            // Check for automation artifacts
            logTechnical('// Automation Artifacts');
            const artifacts = [
                'window.callPhantom',
                'window._phantom',
                'window.phantom',
                'window.Buffer',
                'window.emit',
                'window.spawn',
                'window.webdriver',
                'window.playwright',
                'window.puppeteer'
            ];

            artifacts.forEach(artifact => {
                try {
                    const exists = eval(artifact);
                    logTechnical(`${artifact}: ${exists ? 'DETECTED' : 'not found'}`);
                } catch (e) {
                    logTechnical(`${artifact}: not found`);
                }
            });

            logTechnical('');
            logTechnical('// Analysis complete');
        }

        function toggleInjectionMonitoring() {
            monitoringActive = !monitoringActive;
            const button = document.getElementById('monitor-injections');
            
            if (monitoringActive) {
                button.textContent = 'Stop Monitoring';
                button.className = 'btn btn-danger';
                startInjectionMonitoring();
                logActivity('Injection monitoring started', 'info');
            } else {
                button.textContent = 'Monitor Injections';
                button.className = 'btn btn-success';
                logActivity('Injection monitoring stopped', 'info');
            }
        }

        function startInjectionMonitoring() {
            // Monitor for new script injections
            const observer = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'SCRIPT') {
                                logActivity(`New script injected: ${node.src || 'inline script'}`, 'warning');
                            }
                        });
                    }
                });
            });

            observer.observe(document.documentElement, {
                childList: true,
                subtree: true
            });
        }

        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalExtensions: detectedExtensions.length,
                    contentScripts: contentScripts.length,
                    aiAgents: aiAgents.length,
                    suspiciousExtensions: detectedExtensions.filter(ext => ext.riskLevel === 'high').length
                },
                detectedExtensions: detectedExtensions,
                contentScripts: contentScripts,
                aiAgents: aiAgents,
                browserInfo: {
                    userAgent: navigator.userAgent,
                    webdriver: navigator.webdriver,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    platform: navigator.platform
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `extension-detection-report-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logActivity('Report exported successfully', 'success');
        }

        // Test functions
        function testContentScript() {
            const script = document.createElement('script');
            script.src = 'chrome-extension://test-extension-id/content.js';
            script.onerror = () => {}; // Prevent error
            document.head.appendChild(script);
            setTimeout(() => document.head.removeChild(script), 1000);
            logActivity('Test: Content script injection simulated', 'warning');
        }

        function testAIAgent() {
            const testElement = document.createElement('div');
            testElement.id = 'pplx-agent-overlay-stop-button';
            testElement.style.display = 'none';
            document.body.appendChild(testElement);
            setTimeout(() => document.body.removeChild(testElement), 2000);
            logActivity('Test: AI agent pattern injected', 'warning');
        }

        function testDOMInjection() {
            const testElement = document.createElement('div');
            testElement.setAttribute('data-extension', 'test-extension');
            testElement.style.display = 'none';
            document.body.appendChild(testElement);
            setTimeout(() => document.body.removeChild(testElement), 2000);
            logActivity('Test: Extension DOM injection simulated', 'warning');
        }

        function testStyleOverride() {
            const originalColor = document.body.style.backgroundColor;
            document.body.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
            setTimeout(() => {
                document.body.style.backgroundColor = originalColor;
            }, 2000);
            logActivity('Test: Style override simulation', 'warning');
        }

        function testGlobalVariable() {
            window.testExtensionGlobal = { detected: true };
            setTimeout(() => {
                delete window.testExtensionGlobal;
            }, 2000);
            logActivity('Test: Global variable injection simulated', 'warning');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeExtensionDetector);
    </script>
</body>
</html>
